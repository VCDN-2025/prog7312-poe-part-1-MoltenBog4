@model IEnumerable<ST10028058_PROG7312_POE.Models.Issue>
@{
    ViewData["Title"] = "My Reports";

    int totalCount = 0;
    if (ViewBag.TotalCount is int c) totalCount = c;
    else { foreach (var _ in Model) totalCount++; }

    string? inviteRaw = TempData["InviteRateIssueId"] as string;
    Guid inviteId = Guid.Empty;
    bool hasInvite = !string.IsNullOrWhiteSpace(inviteRaw) && Guid.TryParse(inviteRaw, out inviteId);

    string? successMsg = TempData["Success"] as string;
}

<div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">
        My Reports
        <span class="badge rounded-pill text-bg-primary align-middle">@totalCount</span>
    </h2>
    <a class="btn btn-success" asp-action="Create">
        <i class="bi bi-plus-circle me-1"></i> Report a new issue
    </a>
</div>

@if (!string.IsNullOrWhiteSpace(successMsg))
{
    <div class="alert alert-success shadow-sm rounded">@successMsg</div>
}

@if (hasInvite)
{
    <div class="alert alert-info d-flex align-items-center justify-content-between shadow-sm rounded">
        <div class="me-3">
            <strong>Thanks for your report.</strong> Please rate your experience to help us improve.
        </div>
        <a class="btn btn-primary" asp-controller="Feedback" asp-action="Create" asp-route-issueId="@inviteId">
            Rate now
        </a>
    </div>
}

@{
    bool any = false; foreach (var __ in Model) { any = true; break; }
}

@if (!any)
{
    <div class="alert alert-light border rounded shadow-sm">You haven’t reported any issues yet.</div>
}
else
{
    <div class="card shadow-sm rounded">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-bordered mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th class="w-15">Submitted</th>
                            <th class="w-20">Location</th>
                            <th class="w-15">Category</th>
                            <th>Description</th>
                            <th class="w-10">Attachment</th>
                            <th class="w-10"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var i in Model)
                        {
                            var shortDesc = i.Description ?? "";
                            if (shortDesc.Length > 80) shortDesc = shortDesc.Substring(0, 80) + "...";
                            <tr>
                                <td><span class="badge text-bg-secondary">@i.SubmittedAt.ToString("yyyy-MM-dd HH:mm")</span></td>
                                <td>@i.Location</td>
                                <td><span class="badge rounded-pill text-bg-info">@i.Category</span></td>
                                <td>@shortDesc</td>
                                <td>
                                    @if (!string.IsNullOrEmpty(i.AttachmentFileName))
                                    {
                                        <a class="link-primary" href="~/uploads/@i.AttachmentFileName" target="_blank">View</a>
                                    }
                                    else
                                    {

                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td class="text-end">
                                    <a class="btn btn-sm btn-outline-primary" asp-action="Details" asp-route-id="@i.Id">Details</a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}
@* 
//# Assistance provided by ChatGPT
//# Code and support generated with the help of OpenAI's ChatGPT.
// code attribution
// W3schools
//https://www.w3schools.com/cs/index.php

// code attribution
//Bootswatch
//https://bootswatch.com/

// code attribution
// https://learn.microsoft.com/en-us/aspnet/core/tutorials/first-mvc-app/start-mvc?view=aspnetcore-8.0&tabs=visual-studio

// code attribution
// https://learn.microsoft.com/en-us/aspnet/core/security/authentication/identity?view=aspnetcore-8.0&tabs=visual-studio *@