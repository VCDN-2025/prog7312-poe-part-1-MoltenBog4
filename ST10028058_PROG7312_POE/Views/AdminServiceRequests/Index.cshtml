@model IEnumerable<ST10028058_PROG7312_POE.Models.ServiceRequestModel>
@{
    ViewData["Title"] = "Manage Service Requests";
}

<div class="container mt-5 mb-5">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-dark mb-0">🛠️ Admin — Manage Service Requests</h2>
    </div>

    <!-- Alerts -->
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success shadow-sm">@TempData["Success"]</div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger shadow-sm">@TempData["Error"]</div>
    }
    @if (ViewBag.TopPriority != null)
    {
        <div class="alert alert-warning shadow-sm">
            <strong>🚨 Highest Priority:</strong> @ViewBag.TopPriority.Title (@ViewBag.TopPriority.Category)
        </div>
    }

    <!-- Filter Bar -->
    <form method="get" class="row g-2 align-items-center mb-4 shadow-sm p-3 rounded-4" style="background:#f8f9fa;">
        <div class="col-md-3">
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0">
                    <i class="bi bi-search text-muted"></i>
                </span>
                <input type="text" name="q" value="@ViewBag.Search" class="form-control border-start-0"
                       placeholder="Search by title, area, or category..." />
            </div>
        </div>

        <div class="col-md-2">
            <select name="status" class="form-select">
                <option value="">All Statuses</option>
                <option value="Pending" selected="@(ViewBag.SelectedStatus == "Pending")">Pending</option>
                <option value="InProgress" selected="@(ViewBag.SelectedStatus == "InProgress")">In Progress</option>
                <option value="Completed" selected="@(ViewBag.SelectedStatus == "Completed")">Completed</option>
                <option value="Cancelled" selected="@(ViewBag.SelectedStatus == "Cancelled")">Cancelled</option>
            </select>
        </div>

        <div class="col-md-2">
            <select name="priority" class="form-select">
                <option value="">All Priorities</option>
                <option value="1" selected="@(ViewBag.SelectedPriority == 1)">Critical</option>
                <option value="2" selected="@(ViewBag.SelectedPriority == 2)">High</option>
                <option value="3" selected="@(ViewBag.SelectedPriority == 3)">Medium</option>
                <option value="4" selected="@(ViewBag.SelectedPriority == 4)">Low</option>
                <option value="5" selected="@(ViewBag.SelectedPriority == 5)">Very Low</option>
            </select>
        </div>

        <div class="col-md-2">
            <select name="category" class="form-select">
                <option value="">All Categories</option>
                @if (ViewBag.Categories != null)
                {
                    foreach (var c in ViewBag.Categories)
                    {
                        <option value="@c" selected="@(ViewBag.SelectedCategory == c)">@c</option>
                    }
                }
            </select>
        </div>

        <div class="col-md-3 d-flex gap-2">
            <button class="btn btn-gradient fw-bold text-white px-4" type="submit">Filter</button>
            <a href="@Url.Action("Index", "AdminServiceRequests")" class="btn btn-outline-danger fw-bold px-4">Reset</a>
        </div>
    </form>

    <!-- No Requests -->
    @if (!Model.Any())
    {
        <div class="alert alert-info text-center shadow-sm py-3">No service requests found.</div>
    }
    else
    {
        <!-- Table -->
        <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
            <div class="card-header text-white py-3" style="background: linear-gradient(90deg, #28a745, #20c997);">
                <h5 class="fw-bold mb-0"><i class="bi bi-clipboard-data me-2"></i>Service Requests Overview</h5>
            </div>

            <div class="card-body bg-light p-3">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0 rounded-3 overflow-hidden shadow-sm">
                        <thead class="table-success text-dark">
                            <tr>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Area</th>
                                <th>Category</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Date Submitted</th>
                                <th>Last Updated</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white">
                            @foreach (var r in Model)
                            {
                                <tr id="row-@r.RequestId" class="table-row-hover">
                                    <td>@r.RequestId</td>
                                    <td>@r.Title</td>
                                    <td>@r.Area</td>
                                    <td>@r.Category</td>

                                    <!-- Priority Dropdown -->
                                    <td>
                                        <select class="form-select form-select-sm fw-semibold priority-dropdown"
                                                data-id="@r.RequestId" style="min-width: 120px;">
                                            <option value="1" selected="@(r.Priority == 1)">Critical</option>
                                            <option value="2" selected="@(r.Priority == 2)">High</option>
                                            <option value="3" selected="@(r.Priority == 3)">Medium</option>
                                            <option value="4" selected="@(r.Priority == 4)">Low</option>
                                            <option value="5" selected="@(r.Priority == 5)">Very Low</option>
                                        </select>
                                    </td>

                                    <!-- Status Dropdown -->
                                    <td>
                                        <select class="form-select form-select-sm fw-semibold status-dropdown"
                                                data-id="@r.RequestId" style="min-width: 120px;">
                                            <option value="Pending" selected="@(r.Status == RequestStatus.Pending)">Pending</option>
                                            <option value="InProgress" selected="@(r.Status == RequestStatus.InProgress)">In Progress</option>
                                            <option value="Completed" selected="@(r.Status == RequestStatus.Completed)">Completed</option>
                                            <option value="Cancelled" selected="@(r.Status == RequestStatus.Cancelled)">Cancelled</option>
                                        </select>
                                    </td>

                                    <td>@r.DateSubmitted.ToLocalTime().ToString("yyyy-MM-dd")</td>
                                    <td id="updated-@r.RequestId">@r.LastUpdated.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>

                                    <td class="text-center">
                                        <a class="btn btn-sm btn-outline-success fw-semibold me-2"
                                           asp-action="ViewRequest" asp-route-id="@r.RequestId">
                                            <i class="bi bi-eye me-1"></i>View
                                        </a>
                                        <form asp-action="Delete" method="post" class="d-inline"
                                              onsubmit="return confirm('Delete request @r.RequestId ?');">
                                            <input type="hidden" name="id" value="@r.RequestId" />
                                            <button class="btn btn-sm btn-outline-danger fw-semibold" type="submit">
                                                <i class="bi bi-trash me-1"></i>Delete
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        $(document).ready(function () {

            // ===== STATUS UPDATE =====
            $(".status-dropdown").change(function () {
                const id = $(this).data("id");
                const newStatus = $(this).val();
                const row = $("#row-" + id);
                const updatedCell = $("#updated-" + id);

                $.ajax({
                    url: '@Url.Action("UpdateStatusAjax", "AdminServiceRequests")',
                    type: 'POST',
                    data: { id: id, status: newStatus },
                    success: function (response) {
                        if (response.success) {
                            row.css("background-color", "#d1f7d6");
                            setTimeout(() => row.css("background-color", ""), 1000);
                            toastr.success(response.message);
                            updatedCell.text(response.lastUpdated);
                        } else {
                            row.css("background-color", "#f8d7da");
                            setTimeout(() => row.css("background-color", ""), 1500);
                            toastr.warning(response.message);
                        }
                    },
                    error: function () {
                        toastr.error("❌ Something went wrong while updating status.");
                    }
                });
            });

            // ===== PRIORITY UPDATE =====
            $(".priority-dropdown").change(function () {
                const id = $(this).data("id");
                const newPriority = $(this).val();
                const row = $("#row-" + id);
                const updatedCell = $("#updated-" + id);

                $.ajax({
                    url: '@Url.Action("UpdatePriorityAjax", "AdminServiceRequests")',
                    type: 'POST',
                    data: { id: id, priority: newPriority },
                    success: function (response) {
                        if (response.success) {
                            row.css("background-color", "#fff3cd");
                            setTimeout(() => row.css("background-color", ""), 1000);
                            toastr.info(response.message);
                            updatedCell.text(response.lastUpdated);
                        } else {
                            row.css("background-color", "#f8d7da");
                            setTimeout(() => row.css("background-color", ""), 1500);
                            toastr.warning(response.message);
                        }
                    },
                    error: function () {
                        toastr.error("❌ Something went wrong while updating priority.");
                    }
                });
            });
        });
    </script>

    <!-- Toastr Notifications -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
}

<!-- Custom Styling -->
<style>
    .btn-gradient {
        background: linear-gradient(90deg, #28a745, #20c997);
        border: none;
        transition: all 0.2s ease-in-out;
    }

        .btn-gradient:hover {
            transform: translateY(-1px);
            background: linear-gradient(90deg, #218838, #17a589);
        }

    .status-pending {
        background-color: #ffcd39;
        color: #000;
        font-weight: 600;
    }

    .status-inprogress {
        background-color: #17a2b8;
        color: #fff;
        font-weight: 600;
    }

    .status-completed {
        background-color: #28a745;
        color: #fff;
        font-weight: 600;
    }

    .status-cancelled {
        background-color: #dc3545;
        color: #fff;
        font-weight: 600;
    }

    .priority-critical {
        background-color: #dc3545 !important;
        color: #fff !important;
    }

    .priority-high {
        background-color: #fd7e14 !important;
        color: #fff !important;
    }

    .priority-medium {
        background-color: #ffc107 !important;
        color: #000 !important;
    }

    .priority-low {
        background-color: #6c757d !important;
        color: #fff !important;
    }

    thead th {
        font-weight: 600;
        background-color: #eafaf1 !important;
    }

    tbody tr.table-row-hover {
        transition: background-color 0.2s ease, transform 0.2s ease;
    }

        tbody tr.table-row-hover:hover {
            background-color: #f8fdf9;
            transform: translateX(4px);
        }

    .btn-outline-success:hover {
        background-color: #28a745 !important;
        color: #fff !important;
    }

    .btn-outline-danger:hover {
        background-color: #dc3545 !important;
        color: #fff !important;
    }
</style>
